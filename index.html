<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>TimeTrack Pro 2.0 Master</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* --- CSS VARIABLER FÖR LJUST / MÖRKT TEMA --- */
        :root {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --card-bg: white;
            --card-border: #f1f5f9;
            --nav-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --input-bg: white;
            --input-border: #cbd5e1;
            --text-muted: #64748b;
            --table-hover: #f8fafc;
            --stat-bg: #f8fafc;
            --modal-overlay: rgba(15, 23, 42, 0.6);
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --card-bg: #1e293b;
            --card-border: #334155;
            --nav-bg: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            --input-bg: #0f172a;
            --input-border: #475569;
            --text-muted: #94a3b8;
            --table-hover: #0f172a;
            --stat-bg: #0f172a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: all 0.3s;
        }

        /* Navigation */
        nav {
            background: var(--nav-bg);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }

            nav .nav-title {
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            nav button {
                padding: 0.6rem 1.2rem;
                cursor: pointer;
                font-weight: 600;
                border: none;
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
                transition: all 0.2s;
            }

                nav button:hover {
                    background-color: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

        /* Nätverksindikator */
        .network-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

            .network-badge.online {
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }

            .network-badge.offline {
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

        .container {
            padding: 2rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--nav-bg);
            color: white;
            text-align: center;
        }

        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 3rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
        }

            .login-box h1 {
                margin-top: 0;
                margin-bottom: 0.5rem;
                font-size: 2.2rem;
            }

        .pin-input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2);
            color: white;
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            outline: none;
            box-sizing: border-box;
        }

            .pin-input:focus {
                border-color: #3b82f6;
            }

        .login-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: 0.2s;
        }

            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            }

        /* Klockan */
        .live-clock-container {
            text-align: center;
            margin-bottom: 2.5rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            border: 1px solid var(--card-border);
        }

        /* Kort & Knappar */
        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border: 1px solid var(--card-border);
        }

            .card h3 {
                margin-top: 0;
                border-bottom: 2px solid var(--card-border);
                padding-bottom: 0.75rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

            .btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

        .btn-in {
            background-color: #10b981;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-break {
            background-color: #f97316;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-out {
            background-color: #3b82f6;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-out-ob {
            background-color: #8b5cf6;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-sick {
            background-color: #ef4444;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-leave {
            background-color: #ec4899;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background-color: #3b82f6;
            width: 100%;
            justify-content: center;
        }

        .btn-secondary {
            background-color: #64748b;
            width: 100%;
            justify-content: center;
        }

        .btn-export {
            background-color: #10b981;
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            color: white;
        }

        .btn-edit {
            background-color: #3b82f6;
        }

        .btn-delete {
            background-color: #ef4444;
        }

        /* Live Timer för arbetare */
        .live-timer {
            font-size: 2.5rem;
            font-family: monospace;
            text-align: center;
            margin: 1.5rem 0;
            font-weight: bold;
            color: #3b82f6;
            letter-spacing: 2px;
        }

        /* Formulär & Sök */
        .form-group {
            margin-bottom: 1.25rem;
            width: 100%;
        }

            .form-group label {
                display: block;
                font-size: 0.85rem;
                margin-bottom: 0.4rem;
                font-weight: 600;
                color: var(--text-muted);
            }

            .form-group input {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--input-border);
                border-radius: 8px;
                box-sizing: border-box;
                background: var(--input-bg);
                color: var(--text-color);
                outline: none;
            }

                .form-group input:focus {
                    border-color: #3b82f6;
                }

        .search-bar {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        /* Tabeller & Listor */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }

        th {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        tr:hover {
            background-color: var(--table-hover);
        }

        .clickable-name {
            color: #3b82f6;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: 0.2s;
        }

            .clickable-name:hover {
                text-decoration-color: #3b82f6;
            }

        .schedule-list, .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .schedule-list li, .log-list li {
                padding: 0.85rem 0;
                border-bottom: 1px dashed var(--card-border);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

        .log-time {
            color: var(--text-muted);
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* Badges */
        .badge {
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

            .badge.inloggad {
                background-color: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }

            .badge.utloggad {
                background-color: rgba(100, 116, 139, 0.2);
                color: var(--text-muted);
            }

            .badge.rast {
                background-color: rgba(249, 115, 22, 0.2);
                color: #ea580c;
            }

            .badge.sjuk {
                background-color: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

            .badge.semester {
                background-color: rgba(236, 72, 153, 0.2);
                color: #ec4899;
            }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--card-border);
        }

        .stat-box {
            background: var(--stat-bg);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

            .stat-box span {
                display: block;
                font-size: 0.8rem;
                color: var(--text-muted);
                font-weight: 600;
                text-transform: uppercase;
                margin-bottom: 0.25rem;
            }

            .stat-box strong {
                font-size: 1.5rem;
            }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            width: 90%;
            max-width: 550px;
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            border: none;
            background: transparent;
        }

            .modal-close:hover {
                color: var(--text-color);
            }

        /* Kvitto Design */
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--card-border);
        }

        .receipt-total {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: bold;
            border-top: 2px solid var(--text-color);
            margin-top: 1rem;
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            min-width: 250px;
            background: white;
            color: #0f172a;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-left: 5px solid #3b82f6;
            animation: slideIn 0.3s forwards, fadeOut 0.3s 2.7s forwards;
        }

            .toast.success {
                border-color: #10b981;
            }

            .toast.error {
                border-color: #ef4444;
            }

            .toast.warning {
                border-color: #f97316;
            }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .hidden {
            display: none !important;
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="toast-container" aria-live="polite"></div>

    <div id="login-screen">
        <div class="login-box">
            <h1>⏱️ TimeTrack Pro</h1>
            <p style="margin-bottom: 2rem; color: #94a3b8;">Säker inloggning med personlig PIN.</p>
            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Admin: 9999 | Alex: 1234 | Sara: 5678</p>
            <input type="password" id="login-pin" class="pin-input" placeholder="****" maxlength="4" autocomplete="off">
            <button class="login-btn" onclick="doLogin()">Logga in</button>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <nav>
            <div class="nav-title">
                <span>⏱️ TimeTrack</span>
                <span id="logged-in-user" style="color: #3b82f6; font-size: 1rem;"></span>
            </div>

            <div style="display: flex; gap: 1rem; align-items: center;">
                <div id="network-status" class="network-badge online">🟢 Online</div>
                <button onclick="toggleDarkMode()">🌙 Tema</button>
                <button onclick="logout()" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5;">Logga ut</button>
            </div>
        </nav>

        <div class="container">
            <div id="live-clock" class="live-clock-container" aria-live="polite">Laddar tid...</div>

            <div id="worker-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 id="welcome-message" style="margin: 0;">Din stämpelklocka</h2>
                    <button class="btn btn-secondary" style="width: auto; margin:0;" onclick="openPayslipModal()">🧾 Visa Lönespecifikation</button>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>⏰ Aktuell Status</h3>
                    <p>Status: <span id="worker-status-badge" class="badge utloggad">Utloggad</span></p>

                    <div id="active-session-timer" class="live-timer" style="display: none;">00:00:00</div>

                    <div style="margin-top: 1.5rem; display:flex; flex-wrap: wrap; justify-content: center;" id="worker-action-buttons">
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box"><span>Totalt (Vanlig tid)</span><strong id="worker-hours">0h</strong></div>
                        <div class="stat-box"><span>OB-Timmar</span><strong id="worker-ob-hours" style="color: #8b5cf6;">0h</strong></div>
                        <div class="stat-box"><span>Bruttolön (Totalt)</span><strong id="worker-earned">0 kr</strong></div>
                    </div>
                </div>

                <div class="card">
                    <h3>📅 Mitt Schema</h3>
                    <ul id="schedule-list" class="schedule-list"></ul>

                    <h4 style="margin-top: 2rem;">Lägg till nytt pass</h4>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom:0; flex: 1.5;">
                            <input type="date" id="new-shift-day" required>
                        </div>
                        <div class="form-group" style="margin-bottom:0; flex: 1;">
                            <input type="time" id="new-shift-start" required>
                        </div>
                        <span style="font-weight: bold; color: var(--text-muted);">-</span>
                        <div class="form-group" style="margin-bottom:0; flex: 1;">
                            <input type="time" id="new-shift-end" required>
                        </div>
                        <button class="btn btn-secondary" style="width:auto; margin-top:0;" onclick="addShift()">Lägg till</button>
                    </div>
                </div>
            </div>

            <div id="admin-view" class="hidden">
                <h2>Admin Dashboard</h2>

                <div class="card">
                    <h3>📊 Kostnadsfördelning</h3>
                    <div style="position: relative; height:250px; width:100%;">
                        <canvas id="salaryChart"></canvas>
                    </div>
                </div>

                <div class="admin-grid">
                    <div>
                        <div class="card">
                            <h3>➕ Ny Anställd</h3>
                            <div class="form-group"><label for="new-name">Namn</label><input type="text" id="new-name" placeholder="T.ex. Anna Svensson"></div>
                            <div class="form-group"><label for="new-pin">Personlig PIN (4 siffror)</label><input type="text" id="new-pin" placeholder="T.ex. 4321" maxlength="4"></div>
                            <div class="form-group"><label for="new-wage">Timlön (kr)</label><input type="number" id="new-wage" placeholder="T.ex. 160" min="1"></div>
                            <button class="btn btn-primary" onclick="addEmployee()">Lägg till person</button>
                        </div>
                        <div class="card">
                            <h3>⏱️ Aktivitetslogg</h3>
                            <ul id="activity-log-list" class="log-list"></ul>
                        </div>
                    </div>

                    <div class="card" style="overflow-x: auto;">
                        <h3 style="align-items: center; display: flex; justify-content: space-between;">
                            💰 Löneöversikt
                            <button class="btn btn-export" onclick="exportCSV()">📥 Exportera CSV</button>
                        </h3>
                        <input type="text" id="search-employee" class="search-bar" placeholder="Sök efter anställd..." onkeyup="filterTable()">
                        <table style="min-width: 550px;">
                            <thead>
                                <tr><th>Anställd</th><th>Status</th><th>Vanlig Tid</th><th>OB</th><th>Bruttolön</th><th>Åtgärd</th></tr>
                            </thead>
                            <tbody id="payroll-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="payslip-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePayslipModal()">✖</button>
            <h2 style="margin-top:0; border-bottom: 2px solid var(--card-border); padding-bottom: 1rem;">Lönespecifikation</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Period: <span id="payslip-date"></span></p>
            <p style="font-weight: bold; font-size: 1.1rem; margin-bottom: 2rem;">Namn: <span id="payslip-name" style="color: #3b82f6;"></span></p>

            <div class="receipt-row"><span>Vanlig Arbetstid (<span id="payslip-reg-hours">0</span>h á <span id="payslip-reg-wage">0</span> kr)</span><span id="payslip-reg-total">0 kr</span></div>
            <div class="receipt-row"><span>OB-Tillägg / Helg (<span id="payslip-ob-hours">0</span>h á <span id="payslip-ob-wage">0</span> kr)</span><span id="payslip-ob-total" style="color: #8b5cf6;">0 kr</span></div>
            <div class="receipt-total" style="font-size: 1rem;"><span>Bruttolön (Innan skatt)</span><span id="payslip-grand-total">0 kr</span></div>
            <div class="receipt-row" style="color: #ef4444; border-bottom: none;"><span>Avdragen Skatt (30%)</span><span id="payslip-tax-deduction">-0 kr</span></div>
            <div class="receipt-total" style="margin-top: 0.5rem; color: #10b981; font-size: 1.5rem;"><span>Nettolön (Att få ut)</span><span id="payslip-net-total">0 kr</span></div>

            <button class="btn btn-primary" style="margin-top: 2rem;" onclick="closePayslipModal()">Stäng Kvitto</button>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditModal()">✖</button>
            <h2 id="edit-modal-title" style="margin-top:0; color: #3b82f6;">Profil & Pass</h2>
            <input type="hidden" id="edit-emp-id">

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 150px;"><label for="edit-name">Namn</label><input type="text" id="edit-name"></div>
                <div class="form-group" style="flex: 1; min-width: 100px;"><label for="edit-pin">PIN-kod</label><input type="text" id="edit-pin" maxlength="4"></div>
                <div class="form-group" style="flex: 1; min-width: 100px;"><label for="edit-wage">Timlön (kr)</label><input type="number" id="edit-wage" min="1"></div>
            </div>
            <button class="btn btn-primary" onclick="saveEmployeeEdit()">Spara Grunduppgifter</button>

            <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--card-border);">

            <h3 style="margin-bottom: 1rem;">📅 Planerade Pass</h3>
            <ul id="modal-schedule-list" class="schedule-list" style="margin-bottom: 1.5rem;"></ul>

            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display:block; margin-bottom:0.4rem;">Lägg till pass manuellt</label>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <div class="form-group" style="margin-bottom:0; flex: 1.5;"><input type="date" id="modal-shift-day" required></div>
                <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="modal-shift-start" required></div>
                <span style="font-weight: bold; color: var(--text-muted);">-</span>
                <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="modal-shift-end" required></div>
                <button class="btn btn-secondary" style="margin-top:0; width:auto;" onclick="addShiftFromModal()">Lägg till</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATABAS & GLOBAL STATE ---
        const DB_KEY = 'timetrack_pro_v3';
        const LOGS_KEY = 'timetrack_logs_v3';

        const defaultEmployees = [
            { id: "1", name: "Admin", pin: "9999", role: "admin", wage: 0, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [] },
            { id: "2", name: "Alex (Du)", pin: "1234", role: "worker", wage: 150, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [{ day: "2026-02-27", time: "08:00 - 16:00" }] },
            { id: "3", name: "Sara Andersson", pin: "5678", role: "worker", wage: 160, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [] }
        ];

        let employees = JSON.parse(localStorage.getItem(DB_KEY)) || defaultEmployees;
        let logs = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];
        let currentUser = null;
        let liveTimerInterval = null;

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(employees));
            localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
        }

        // --- 2. VERKTYG, TOASTS & KLOCKA ---
        function showToast(msg, type = '') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerText = msg;
            container.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        function updateClock() {
            const now = new Date();
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('live-clock').innerText = "Systemtid: " + now.toLocaleDateString('sv-SE', opts);
        }
        setInterval(updateClock, 1000); updateClock();

        function addLog(action, userName = null) {
            const name = userName || (currentUser ? currentUser.name : "System");
            logs.unshift({ name, action, time: new Date().toLocaleTimeString('sv-SE') });
            if (logs.length > 15) logs.pop();
            saveData();
            if (currentUser && currentUser.role === 'admin') renderLogs();
        }

        function renderLogs() {
            const list = document.getElementById('activity-log-list');
            if (list) list.innerHTML = logs.map(l => `<li><span><strong>${l.name}</strong>: ${l.action}</span><span class="log-time">${l.time}</span></li>`).join('');
        }

        // --- 3. TEMA OCH NÄTVERK ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('tt_theme', isDark ? 'dark' : 'light');
            if (window.myChart) { Chart.defaults.color = isDark ? '#94a3b8' : '#64748b'; window.myChart.update(); }
        }
        if (localStorage.getItem('tt_theme') === 'dark') document.body.classList.add('dark-mode');

        function updateNetworkStatus(isOnline) {
            const el = document.getElementById('network-status');
            if (isOnline) { el.className = 'network-badge online'; el.innerText = '🟢 Online'; }
            else { el.className = 'network-badge offline'; el.innerText = '🔴 Offline'; showToast('Du är offline. Allt sparas lokalt.', 'warning'); }
        }
        window.addEventListener('online', () => updateNetworkStatus(true));
        window.addEventListener('offline', () => updateNetworkStatus(false));
        if (!navigator.onLine) updateNetworkStatus(false);

        // --- 4. INLOGGNING ---
        function doLogin() {
            const pin = document.getElementById('login-pin').value;
            currentUser = employees.find(emp => emp.pin === pin);

            if (!currentUser) { showToast("Fel PIN-kod", "error"); document.getElementById('login-pin').value = ''; return; }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('logged-in-user').innerText = `👤 ${currentUser.name}`;

            if (currentUser.role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('worker-view').classList.add('hidden');
                loadAdminData(); showToast("Inloggad som Admin", "success");
            } else {
                document.getElementById('worker-view').classList.remove('hidden');
                document.getElementById('admin-view').classList.add('hidden');
                loadWorkerView(); showToast("Välkommen!", "success");
            }
        }

        function logout() {
            clearInterval(liveTimerInterval);
            currentUser = null;
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-pin').value = '';
            showToast("Utloggad.");
        }

        // --- 5. EXAKT TIDTAGNING & ARBETAR-VY ---
        function getElapsedMs(session) {
            if (!session) return 0;
            let total = Date.now() - session.startTime;
            session.breaks.forEach(b => { total -= (b.end ? b.end - b.start : Date.now() - b.start); });
            return total;
        }

        function loadWorkerView() {
            updateWorkerControls();

            // Sammanställ historik
            let totHrs = 0; let obHrs = 0;
            currentUser.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; });

            document.getElementById('worker-hours').innerText = totHrs.toFixed(2) + "h";
            document.getElementById('worker-ob-hours').innerText = obHrs.toFixed(2) + "h";
            document.getElementById('worker-earned').innerText = Math.round((totHrs * currentUser.wage) + (obHrs * currentUser.wage * 1.5)).toLocaleString('sv-SE') + " kr";

            // Ladda schema
            const scheduleUl = document.getElementById('schedule-list'); scheduleUl.innerHTML = '';
            currentUser.schedule.forEach((shift, i) => {
                scheduleUl.innerHTML += `<li><div><strong>${shift.day}</strong> <span style="margin-left:10px; color:var(--text-muted);">${shift.time}</span></div><button class="btn-sm btn-delete" onclick="deleteShiftWorker(${i})">✖ Ta bort</button></li>`;
            });
        }

        function updateWorkerControls() {
            const badge = document.getElementById('worker-status-badge');
            badge.innerText = currentUser.status; badge.className = `badge ${currentUser.status.toLowerCase()}`;

            const btnContainer = document.getElementById('worker-action-buttons');
            const timerEl = document.getElementById('active-session-timer');
            clearInterval(liveTimerInterval);

            if (currentUser.status === 'Utloggad' || currentUser.status === 'Sjuk' || currentUser.status === 'Semester') {
                timerEl.style.display = 'none';
                btnContainer.innerHTML = `
                        <button class="btn btn-in" onclick="clockIn()">▶ Klocka In (GPS)</button>
                        <button class="btn btn-sick" onclick="setStatus('Sjuk')">🤒 Sjuk</button>
                        <button class="btn btn-leave" onclick="setStatus('Semester')">🏖️ Ledighet</button>
                    `;
            } else if (currentUser.status === 'Inloggad') {
                timerEl.style.display = 'block'; startLiveTimer();
                btnContainer.innerHTML = `
                        <button class="btn btn-break" onclick="toggleBreak(true)">☕ Börja Rast</button>
                        <button class="btn btn-out" onclick="clockOut(false)">⏹ Ut (Vanlig)</button>
                        <button class="btn btn-out-ob" onclick="clockOut(true)">🌙 Ut (OB)</button>
                    `;
            } else if (currentUser.status === 'Rast') {
                timerEl.style.display = 'block'; timerEl.innerText = "PAUSAD ☕";
                btnContainer.innerHTML = `<button class="btn btn-in" onclick="toggleBreak(false)">▶ Avsluta Rast</button>`;
            }
        }

        function startLiveTimer() {
            liveTimerInterval = setInterval(() => {
                const diffMs = getElapsedMs(currentUser.activeSession);
                let hours = Math.floor(diffMs / 3600000);
                let mins = Math.floor((diffMs % 3600000) / 60000);
                let secs = Math.floor((diffMs % 60000) / 1000);
                document.getElementById('active-session-timer').innerText = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function clockIn() {
            currentUser.status = 'Inloggad';
            currentUser.activeSession = { startTime: Date.now(), breaks: [] };

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((pos) => { addLog(`Stämplade in 📍 (Lat: ${pos.coords.latitude.toFixed(2)})`); saveData(); }, (err) => { addLog("Stämplade in"); saveData(); }, { timeout: 3000 });
            } else { addLog("Stämplade in"); }

            saveData(); loadWorkerView(); showToast("Inloggad och tiden går!", "success");
        }

        function toggleBreak(isStarting) {
            if (isStarting) {
                currentUser.status = 'Rast'; currentUser.activeSession.breaks.push({ start: Date.now(), end: null });
                addLog("Började rast ☕"); showToast("Rast startad. Tiden är pausad.", "warning");
            } else {
                currentUser.status = 'Inloggad';
                let currentBreak = currentUser.activeSession.breaks.find(b => b.end === null);
                if (currentBreak) currentBreak.end = Date.now();
                addLog("Avslutade rast ▶"); showToast("Åter i arbete.", "success");
            }
            saveData(); loadWorkerView();
        }

        function clockOut(isOB) {
            const ms = getElapsedMs(currentUser.activeSession);
            const hrs = ms / 3600000;

            currentUser.workedHistory.push({ date: new Date().toLocaleDateString('sv-SE'), hours: isOB ? 0 : hrs, obHours: isOB ? hrs : 0 });

            currentUser.status = 'Utloggad'; currentUser.activeSession = null;
            addLog(`Stämplade ut (${isOB ? 'OB' : 'Vanlig'}). Tid: ${hrs.toFixed(2)}h`);
            saveData(); loadWorkerView(); showToast(`Utstämplad! Du loggade ${hrs.toFixed(2)} timmar.`, "success");
        }

        function setStatus(status) { currentUser.status = status; addLog(`Satte status: ${status}`); saveData(); loadWorkerView(); showToast(`Status satt till ${status}`); }

        // Schema för arbetare
        function addShift() {
            const dateVal = document.getElementById('new-shift-day').value;
            const startVal = document.getElementById('new-shift-start').value;
            const endVal = document.getElementById('new-shift-end').value;
            if (!dateVal || !startVal || !endVal) return showToast("Fyll i datum och tider.", "warning");
            if (startVal >= endVal) return showToast("Sluttiden måste vara efter start.", "error");

            currentUser.schedule.push({ day: dateVal, time: `${startVal} - ${endVal}` });
            document.getElementById('new-shift-day').value = ''; document.getElementById('new-shift-start').value = ''; document.getElementById('new-shift-end').value = '';
            saveData(); loadWorkerView(); showToast("Pass tillagt!", "success");
        }
        function deleteShiftWorker(i) { currentUser.schedule.splice(i, 1); saveData(); loadWorkerView(); showToast("Pass borttaget", "warning"); }

        // Kvitto Modal (Brutto & Netto)
        function openPayslipModal() {
            let totHrs = 0; let obHrs = 0;
            currentUser.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; });

            const regPay = totHrs * currentUser.wage;
            const obPay = obHrs * (currentUser.wage * 1.5);
            const gross = regPay + obPay;
            const tax = gross * 0.30;
            const net = gross - tax;

            document.getElementById('payslip-name').innerText = currentUser.name;
            document.getElementById('payslip-date').innerText = new Date().toLocaleDateString('sv-SE', { year: 'numeric', month: 'long' });

            document.getElementById('payslip-reg-hours').innerText = totHrs.toFixed(2);
            document.getElementById('payslip-reg-wage').innerText = currentUser.wage;
            document.getElementById('payslip-reg-total').innerText = Math.round(regPay).toLocaleString('sv-SE') + " kr";

            document.getElementById('payslip-ob-hours').innerText = obHrs.toFixed(2);
            document.getElementById('payslip-ob-wage').innerText = currentUser.wage * 1.5;
            document.getElementById('payslip-ob-total').innerText = Math.round(obPay).toLocaleString('sv-SE') + " kr";

            document.getElementById('payslip-grand-total').innerText = Math.round(gross).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-tax-deduction').innerText = "-" + Math.round(tax).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-net-total').innerText = Math.round(net).toLocaleString('sv-SE') + " kr";

            document.getElementById('payslip-modal').classList.add('active');
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'] });
        }
        function closePayslipModal() { document.getElementById('payslip-modal').classList.remove('active'); }

        // --- 6. ADMIN-VY & DATABAS HANTERING ---
        function loadAdminData() {
            const tbody = document.getElementById('payroll-body'); tbody.innerHTML = '';
            let chartLabels = []; let chartRegularPay = []; let chartOBPay = [];

            renderLogs();

            employees.filter(e => e.role !== 'admin').forEach(emp => {
                let totHrs = 0; let obHrs = 0;
                emp.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; });

                let regPay = totHrs * emp.wage; let obPay = obHrs * (emp.wage * 1.5); let gross = regPay + obPay;

                chartLabels.push(emp.name.split(' ')[0]); chartRegularPay.push(regPay); chartOBPay.push(obPay);

                tbody.innerHTML += `<tr class="employee-row">
                        <td class="emp-name"><strong class="clickable-name" onclick="openEditModal('${emp.id}')">${emp.name}</strong><br><small style="color:var(--text-muted)">${emp.wage} kr/h</small></td>
                        <td><span class="badge ${emp.status.toLowerCase()}">${emp.status}</span></td>
                        <td>${totHrs.toFixed(2)}h</td><td style="color: #8b5cf6; font-weight:bold;">${obHrs.toFixed(2)}h</td>
                        <td><strong>${Math.round(gross).toLocaleString('sv-SE')} kr</strong></td>
                        <td>
                            <button class="btn-sm btn-edit" onclick="openEditModal('${emp.id}')">Redigera</button>
                            <button class="btn-sm btn-delete" onclick="deleteEmployee('${emp.id}')">✖</button>
                        </td>
                    </tr>`;
            });

            updateChart(chartLabels, chartRegularPay, chartOBPay);
        }

        function filterTable() {
            const filter = document.getElementById('search-employee').value.toLowerCase();
            const rows = document.getElementsByClassName('employee-row');
            for (let i = 0; i < rows.length; i++) {
                const nameCol = rows[i].querySelector('.emp-name');
                if (nameCol) rows[i].style.display = (nameCol.textContent || nameCol.innerText).toLowerCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        function addEmployee() {
            const name = document.getElementById('new-name').value;
            const pin = document.getElementById('new-pin').value;
            const wage = parseInt(document.getElementById('new-wage').value);

            if (!name || !pin || isNaN(wage)) return showToast("Fyll i namn, PIN och lön.", "warning");
            if (employees.find(e => e.pin === pin)) return showToast("PIN-koden används redan!", "error");

            employees.push({ id: Date.now().toString(), name, pin, role: "worker", wage, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [] });

            document.getElementById('new-name').value = ''; document.getElementById('new-pin').value = ''; document.getElementById('new-wage').value = '';
            saveData(); loadAdminData(); showToast("Anställd tillagd!", "success");
        }

        function deleteEmployee(id) {
            if (confirm("Är du säker på att du vill radera denna anställd och dess historik?")) {
                employees = employees.filter(e => e.id !== id);
                saveData(); loadAdminData(); showToast("Anställd raderad");
            }
        }

        // Admin Redigera Modal
        function openEditModal(id) {
            const emp = employees.find(e => e.id === id);
            document.getElementById('edit-emp-id').value = id;
            document.getElementById('edit-modal-title').innerText = "Profil: " + emp.name;
            document.getElementById('edit-name').value = emp.name;
            document.getElementById('edit-pin').value = emp.pin;
            document.getElementById('edit-wage').value = emp.wage;
            renderModalSchedule(id);
            document.getElementById('edit-modal').classList.add('active');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }

        function saveEmployeeEdit() {
            const id = document.getElementById('edit-emp-id').value;
            const emp = employees.find(e => e.id === id);
            const newName = document.getElementById('edit-name').value;
            const newPin = document.getElementById('edit-pin').value;
            const newWage = parseInt(document.getElementById('edit-wage').value);

            if (!newName || !newPin || isNaN(newWage)) return showToast("Fyll i alla fält.", "warning");
            if (employees.find(e => e.pin === newPin && e.id !== id)) return showToast("PIN-koden används redan!", "error");

            emp.name = newName; emp.pin = newPin; emp.wage = newWage;
            saveData(); loadAdminData(); showToast("Uppgifter sparade!", "success"); closeEditModal();
        }

        function renderModalSchedule(id) {
            const emp = employees.find(e => e.id === id);
            const list = document.getElementById('modal-schedule-list'); list.innerHTML = '';
            if (emp.schedule.length === 0) { list.innerHTML = '<li><em style="color:var(--text-muted)">Inget schema inlagt.</em></li>'; return; }
            emp.schedule.forEach((shift, index) => {
                list.innerHTML += `<li><div><strong>${shift.day}</strong> <span style="margin-left:10px; color:var(--text-muted);">${shift.time}</span></div><button class="btn-sm btn-delete" onclick="deleteShiftFromModal('${id}', ${index})">✖</button></li>`;
            });
        }
        function deleteShiftFromModal(id, index) { employees.find(e => e.id === id).schedule.splice(index, 1); saveData(); renderModalSchedule(id); }

        function addShiftFromModal() {
            const id = document.getElementById('edit-emp-id').value;
            const dateVal = document.getElementById('modal-shift-day').value;
            const startVal = document.getElementById('modal-shift-start').value;
            const endVal = document.getElementById('modal-shift-end').value;

            if (!dateVal || !startVal || !endVal) return showToast("Fyll i datum och tider.", "warning");
            if (startVal >= endVal) return showToast("Sluttiden måste vara efter start.", "error");

            employees.find(e => e.id === id).schedule.push({ day: dateVal, time: `${startVal} - ${endVal}` });
            document.getElementById('modal-shift-day').value = ''; document.getElementById('modal-shift-start').value = ''; document.getElementById('modal-shift-end').value = '';
            saveData(); renderModalSchedule(id); showToast("Pass tillagt!", "success");
        }

        // Export CSV & Chart
        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Namn;Status;Vanlig Tid(h);OB-Tid(h);Timlon;Bruttolon(kr)\n";
            employees.filter(e => e.role !== 'admin').forEach(emp => {
                let totHrs = 0; let obHrs = 0;
                emp.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; });
                let gross = (totHrs * emp.wage) + (obHrs * emp.wage * 1.5);
                csvContent += `${emp.name};${emp.status};${totHrs.toFixed(2)};${obHrs.toFixed(2)};${emp.wage};${Math.round(gross)}\n`;
            });
            const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "Lonelista_Pro.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast("CSV nedladdad!", "success");
        }

        function updateChart(labels, regularData, obData) {
            const ctx = document.getElementById('salaryChart').getContext('2d');
            Chart.defaults.color = document.body.classList.contains('dark-mode') ? '#94a3b8' : '#64748b'; Chart.defaults.font.family = 'Inter';
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Vanlig Lön (kr)', data: regularData, backgroundColor: '#3b82f6', borderRadius: 4 }, { label: 'OB-tillägg (kr)', data: obData, backgroundColor: '#8b5cf6', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, border: { display: false } } }, plugins: { legend: { position: 'top' } } } });
        }
    </script>
</body>
</html>