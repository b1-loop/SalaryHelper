<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>TimeTrack Pro 2.0 Master</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* --- CSS VARIABLER F√ñR LJUST / M√ñRKT TEMA --- */
        :root {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --card-bg: white;
            --card-border: #f1f5f9;
            --nav-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --input-bg: white;
            --input-border: #cbd5e1;
            --text-muted: #64748b;
            --table-hover: #f8fafc;
            --stat-bg: #f8fafc;
            --modal-overlay: rgba(15, 23, 42, 0.6);
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --card-bg: #1e293b;
            --card-border: #334155;
            --nav-bg: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            --input-bg: #0f172a;
            --input-border: #475569;
            --text-muted: #94a3b8;
            --table-hover: #0f172a;
            --stat-bg: #0f172a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: all 0.3s;
        }

        /* Navigation */
        nav {
            background: var(--nav-bg);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
        }

            nav .nav-title {
                color: white;
                font-weight: bold;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            nav button {
                padding: 0.6rem 1.2rem;
                cursor: pointer;
                font-weight: 600;
                border: none;
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
                transition: all 0.2s;
            }

                nav button:hover {
                    background-color: rgba(255, 255, 255, 0.2);
                    transform: translateY(-1px);
                }

        /* N√§tverksindikator */
        .network-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

            .network-badge.online {
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
            }

            .network-badge.offline {
                background: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

        .container {
            padding: 2rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--nav-bg);
            color: white;
            text-align: center;
        }

        .login-box {
            background: rgba(255,255,255,0.1);
            padding: 3rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
        }

            .login-box h1 {
                margin-top: 0;
                margin-bottom: 0.5rem;
                font-size: 2.2rem;
            }

        .pin-input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.2);
            color: white;
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            outline: none;
            box-sizing: border-box;
        }

            .pin-input:focus {
                border-color: #3b82f6;
            }

        #pin-error {
            color: #fca5a5;
            font-size: 0.85rem;
            font-weight: 600;
            min-height: 1.4em;
            margin: 0 0 0.75rem 0;
        }

        .login-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            transition: 0.2s;
        }

            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            }

        /* PIN shake animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%       { transform: translateX(-8px); }
            40%       { transform: translateX(8px); }
            60%       { transform: translateX(-8px); }
            80%       { transform: translateX(8px); }
        }

        .shake {
            animation: shake 0.4s ease;
            border-color: #ef4444 !important;
        }

        /* Klockan */
        .live-clock-container {
            text-align: center;
            margin-bottom: 2.5rem;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            font-size: 1.25rem;
            font-weight: 700;
            color: #3b82f6;
            border: 1px solid var(--card-border);
        }

        /* Kort & Knappar */
        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border: 1px solid var(--card-border);
        }

            .card h3 {
                margin-top: 0;
                border-bottom: 2px solid var(--card-border);
                padding-bottom: 0.75rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

            .btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

        .btn-in      { background-color: #10b981; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn-break   { background-color: #f97316; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn-out     { background-color: #3b82f6; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn-sick    { background-color: #ef4444; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn-leave   { background-color: #ec4899; margin-bottom: 0.5rem; }
        .btn-primary { background-color: #3b82f6; width: 100%; justify-content: center; }
        .btn-secondary { background-color: #64748b; width: 100%; justify-content: center; }
        .btn-export  { background-color: #10b981; font-size: 0.85rem; padding: 0.5rem 1rem; }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            color: white;
        }

        .btn-edit   { background-color: #3b82f6; }
        .btn-delete { background-color: #ef4444; }

        /* Live Timer */
        .live-timer {
            font-size: 2.5rem;
            font-family: monospace;
            text-align: center;
            margin: 1.5rem 0;
            font-weight: bold;
            color: #3b82f6;
            letter-spacing: 2px;
        }

        /* Formul√§r & S√∂k */
        .form-group {
            margin-bottom: 1.25rem;
            width: 100%;
        }

            .form-group label {
                display: block;
                font-size: 0.85rem;
                margin-bottom: 0.4rem;
                font-weight: 600;
                color: var(--text-muted);
            }

            .form-group input, .form-group select {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--input-border);
                border-radius: 8px;
                box-sizing: border-box;
                background: var(--input-bg);
                color: var(--text-color);
                outline: none;
            }

                .form-group input:focus, .form-group select:focus {
                    border-color: #3b82f6;
                }

        .search-bar {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        /* Tabeller & Listor */
        table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--card-border); }
        th { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        tr:hover { background-color: var(--table-hover); }

        .clickable-name {
            color: #3b82f6;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: 0.2s;
        }

            .clickable-name:hover { text-decoration-color: #3b82f6; }

        .schedule-list, .log-list { list-style: none; padding: 0; margin: 0; }

            .schedule-list li, .log-list li {
                padding: 0.85rem 0;
                border-bottom: 1px dashed var(--card-border);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

        .log-time { color: var(--text-muted); font-family: monospace; font-size: 0.8rem; }

        /* Badges */
        .badge { padding: 0.35rem 0.85rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .badge.inloggad  { background-color: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge.utloggad  { background-color: rgba(100, 116, 139, 0.2); color: var(--text-muted); }
        .badge.rast      { background-color: rgba(249, 115, 22, 0.2); color: #ea580c; }
        .badge.sjuk      { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge.semester  { background-color: rgba(236, 72, 153, 0.2); color: #ec4899; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--card-border);
        }

        .stat-box { background: var(--stat-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--card-border); }
            .stat-box span { display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem; }
            .stat-box strong { font-size: 1.4rem; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-overlay);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

            .modal.active { display: flex; }

        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            width: 90%;
            max-width: 550px;
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .modal-close {
            position: absolute;
            top: 1.5rem; right: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            border: none;
            background: transparent;
        }

            .modal-close:hover { color: var(--text-color); }

        /* Kvitto */
        .receipt-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--card-border); }
        .receipt-total { display: flex; justify-content: space-between; padding: 1rem 0; font-size: 1.25rem; font-weight: bold; border-top: 2px solid var(--text-color); margin-top: 1rem; }

        /* Toasts */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }

        .toast { min-width: 250px; background: white; color: #0f172a; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-left: 5px solid #3b82f6; animation: slideIn 0.3s forwards, fadeOut 0.3s 2.7s forwards; }
            .toast.success { border-color: #10b981; }
            .toast.error   { border-color: #ef4444; }
            .toast.warning { border-color: #f97316; }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }

        .hidden { display: none !important; }

        .admin-grid { display: grid; grid-template-columns: 350px 1fr; gap: 2rem; }

        @media (max-width: 900px) { .admin-grid { grid-template-columns: 1fr; } }

        /* Period filter row */
        .period-filter-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .period-filter-row label { font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }

        .period-select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Print ‚Äî show only payslip */
        @media print {
            body * { visibility: hidden; }
            #payslip-modal, #payslip-modal * { visibility: visible; }
            #payslip-modal {
                position: fixed;
                left: 0; top: 0;
                width: 100%; height: auto;
                background: white !important;
                display: block !important;
                backdrop-filter: none;
            }
            #payslip-modal .modal-content {
                max-height: none;
                overflow: visible;
                box-shadow: none;
                border: none;
                max-width: 100%;
                width: 100%;
            }
            .modal-close, #payslip-print-btn { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="toast-container" aria-live="polite"></div>

    <!-- ===== LOGIN ===== -->
    <div id="login-screen">
        <div class="login-box">
            <h1>‚è±Ô∏è TimeTrack Pro</h1>
            <p style="margin-bottom: 2rem; color: #94a3b8;">S√§ker inloggning med personlig PIN.</p>
            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Admin: 9999 | Alex: 1234 | Sara: 5678</p>
            <input type="password" id="login-pin" class="pin-input" placeholder="****" maxlength="4" autocomplete="off" oninput="clearPinError()">
            <p id="pin-error"></p>
            <button class="login-btn" onclick="doLogin()">Logga in</button>
        </div>
    </div>

    <!-- ===== APP ===== -->
    <div id="app-content" class="hidden">
        <nav>
            <div class="nav-title">
                <span id="nav-company-name">‚è±Ô∏è TimeTrack</span>
                <span id="logged-in-user" style="color: #3b82f6; font-size: 1rem;"></span>
            </div>

            <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
                <div id="network-status" class="network-badge online">üü¢ Online</div>
                <button id="settings-btn" class="hidden" onclick="openSettingsModal()">‚öôÔ∏è Inst√§llningar</button>
                <button onclick="toggleDarkMode()">üåô Tema</button>
                <button onclick="logout()" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5;">Logga ut</button>
            </div>
        </nav>

        <div class="container">
            <div id="live-clock" class="live-clock-container" aria-live="polite">Laddar tid...</div>

            <!-- ===== WORKER VIEW ===== -->
            <div id="worker-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2 id="welcome-message" style="margin: 0;">Din st√§mpelklocka</h2>
                    <button class="btn btn-secondary" style="width: auto; margin:0;" onclick="openPayslipModal()">üßæ Visa L√∂nespecifikation</button>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <h3>‚è∞ Aktuell Status</h3>
                    <p>Status: <span id="worker-status-badge" class="badge utloggad">Utloggad</span></p>

                    <div id="active-session-timer" class="live-timer" style="display: none;">00:00:00</div>

                    <div style="margin-top: 1.5rem; display:flex; flex-wrap: wrap; justify-content: center;" id="worker-action-buttons"></div>

                    <div class="stats-grid">
                        <div class="stat-box"><span>Vanlig Tid</span><strong id="worker-hours">0h</strong></div>
                        <div class="stat-box"><span>OB-Timmar</span><strong id="worker-ob-hours" style="color: #8b5cf6;">0h</strong></div>
                        <div class="stat-box"><span>√ñvertid</span><strong id="worker-ot-hours" style="color: #f97316;">0h</strong></div>
                        <div class="stat-box"><span>Bruttol√∂n</span><strong id="worker-earned">0 kr</strong></div>
                        <div class="stat-box"><span>Semesterdagar kvar</span><strong id="worker-vacation-days" style="color: #10b981;">25</strong></div>
                        <div class="stat-box"><span>Sjukdagar</span><strong id="worker-sick-days" style="color: #ef4444;">0</strong></div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Mitt Schema</h3>
                    <ul id="schedule-list" class="schedule-list"></ul>

                    <h4 style="margin-top: 2rem;">L√§gg till nytt pass</h4>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom:0; flex: 1.5;"><input type="date" id="new-shift-day" required></div>
                        <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="new-shift-start" required></div>
                        <span style="font-weight: bold; color: var(--text-muted);">-</span>
                        <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="new-shift-end" required></div>
                        <button class="btn btn-secondary" style="width:auto; margin-top:0;" onclick="addShift()">L√§gg till</button>
                    </div>
                </div>
            </div>

            <!-- ===== ADMIN VIEW ===== -->
            <div id="admin-view" class="hidden">
                <h2>Admin Dashboard</h2>

                <div class="card">
                    <h3>üìä Kostnadsf√∂rdelning</h3>
                    <div style="position: relative; height:250px; width:100%;">
                        <canvas id="salaryChart"></canvas>
                    </div>
                </div>

                <div class="admin-grid">
                    <div>
                        <div class="card">
                            <h3>‚ûï Ny Anst√§lld</h3>
                            <div class="form-group"><label for="new-name">Namn</label><input type="text" id="new-name" placeholder="T.ex. Anna Svensson"></div>
                            <div class="form-group"><label for="new-pin">Personlig PIN (4 siffror)</label><input type="text" id="new-pin" placeholder="T.ex. 4321" maxlength="4"></div>
                            <div class="form-group"><label for="new-wage">Timl√∂n (kr)</label><input type="number" id="new-wage" placeholder="T.ex. 160" min="1"></div>
                            <button class="btn btn-primary" onclick="addEmployee()">L√§gg till person</button>
                        </div>

                        <div class="card">
                            <h3>‚è±Ô∏è Aktivitetslogg</h3>
                            <input type="text" id="log-search" class="search-bar" placeholder="S√∂k i logg..." oninput="renderLogs()">
                            <ul id="activity-log-list" class="log-list"></ul>
                            <button id="log-show-more" class="btn btn-secondary" style="margin-top: 1rem; display: none;" onclick="showMoreLogs()">Visa fler</button>
                        </div>
                    </div>

                    <div class="card" style="overflow-x: auto;">
                        <h3 style="align-items: center; display: flex; justify-content: space-between;">
                            üí∞ L√∂ne√∂versikt
                            <button class="btn btn-export" onclick="exportCSV()">üì• Exportera CSV</button>
                        </h3>
                        <div class="period-filter-row">
                            <label>L√∂neperiod:</label>
                            <select id="period-filter" class="period-select" onchange="loadAdminData()">
                                <option value="all">Allt</option>
                                <option value="week">Denna vecka</option>
                                <option value="month">Denna m√•nad</option>
                            </select>
                        </div>
                        <input type="text" id="search-employee" class="search-bar" placeholder="S√∂k efter anst√§lld..." onkeyup="filterTable()">
                        <table style="min-width: 550px;">
                            <thead>
                                <tr><th>Anst√§lld</th><th>Status</th><th>Vanlig Tid</th><th>OB</th><th>Bruttol√∂n</th><th>√Ötg√§rd</th></tr>
                            </thead>
                            <tbody id="payroll-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PAYSLIP MODAL ===== -->
    <div id="payslip-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePayslipModal()">‚úñ</button>
            <div style="text-align: center; margin-bottom: 0.75rem;">
                <strong id="payslip-company" style="font-size: 1rem; color: var(--text-muted);"></strong>
            </div>
            <h2 style="margin-top:0; border-bottom: 2px solid var(--card-border); padding-bottom: 1rem;">L√∂nespecifikation</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Period: <span id="payslip-date"></span></p>
            <p style="font-weight: bold; font-size: 1.1rem; margin-bottom: 2rem;">Namn: <span id="payslip-name" style="color: #3b82f6;"></span></p>

            <div class="receipt-row">
                <span>Vanlig Arbetstid (<span id="payslip-reg-hours">0</span>h √° <span id="payslip-reg-wage">0</span> kr)</span>
                <span id="payslip-reg-total">0 kr</span>
            </div>
            <div class="receipt-row">
                <span>OB-Till√§gg / Helg (<span id="payslip-ob-hours">0</span>h √° <span id="payslip-ob-wage">0</span> kr)</span>
                <span id="payslip-ob-total" style="color: #8b5cf6;">0 kr</span>
            </div>
            <div class="receipt-row">
                <span>√ñvertid &gt;8h/dag (<span id="payslip-ot-hours">0</span>h √ó 50% till√§gg √° <span id="payslip-ot-wage">0</span> kr)</span>
                <span id="payslip-ot-total" style="color: #f97316;">0 kr</span>
            </div>
            <div class="receipt-total" style="font-size: 1rem;"><span>Bruttol√∂n (Innan skatt)</span><span id="payslip-grand-total">0 kr</span></div>
            <div class="receipt-row" style="color: #ef4444;"><span>Kommunalskatt (31.49%)</span><span id="payslip-kommunal">-0 kr</span></div>
            <div class="receipt-row" style="color: #ef4444; border-bottom: none;"><span>Statlig skatt (20% p√• belopp √∂ver 46 000 kr/m√•n)</span><span id="payslip-statlig">-0 kr</span></div>
            <div class="receipt-total" style="margin-top: 0.5rem; color: #10b981; font-size: 1.5rem;"><span>Nettol√∂n (Att f√• ut)</span><span id="payslip-net-total">0 kr</span></div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                <button id="payslip-print-btn" class="btn btn-primary" style="flex: 1;" onclick="window.print()">üñ®Ô∏è Skriv ut / Spara PDF</button>
                <button class="btn btn-secondary" style="flex: 1;" onclick="closePayslipModal()">St√§ng Kvitto</button>
            </div>
        </div>
    </div>

    <!-- ===== EDIT MODAL ===== -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEditModal()">‚úñ</button>
            <h2 id="edit-modal-title" style="margin-top:0; color: #3b82f6;">Profil & Pass</h2>
            <input type="hidden" id="edit-emp-id">

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 140px;"><label for="edit-name">Namn</label><input type="text" id="edit-name"></div>
                <div class="form-group" style="flex: 1; min-width: 90px;"><label for="edit-pin">PIN-kod</label><input type="text" id="edit-pin" maxlength="4"></div>
                <div class="form-group" style="flex: 1; min-width: 90px;"><label for="edit-wage">Timl√∂n (kr)</label><input type="number" id="edit-wage" min="1"></div>
                <div class="form-group" style="flex: 1; min-width: 90px;"><label for="edit-vacation-days">Semesterdagar kvar</label><input type="number" id="edit-vacation-days" min="0"></div>
            </div>

            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" style="flex: 2;" onclick="saveEmployeeEdit()">Spara Grunduppgifter</button>
                <button class="btn" style="background: #ef4444; flex: 1;" onclick="clearEmployeeHistory()">üóëÔ∏è Rensa historik</button>
            </div>

            <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--card-border);">

            <h3 style="margin-bottom: 1rem;">üìÖ Planerade Pass</h3>
            <ul id="modal-schedule-list" class="schedule-list" style="margin-bottom: 1.5rem;"></ul>

            <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted); display:block; margin-bottom:0.4rem;">L√§gg till pass manuellt</label>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <div class="form-group" style="margin-bottom:0; flex: 1.5;"><input type="date" id="modal-shift-day" required></div>
                <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="modal-shift-start" required></div>
                <span style="font-weight: bold; color: var(--text-muted);">-</span>
                <div class="form-group" style="margin-bottom:0; flex: 1;"><input type="time" id="modal-shift-end" required></div>
                <button class="btn btn-secondary" style="margin-top:0; width:auto;" onclick="addShiftFromModal()">L√§gg till</button>
            </div>
        </div>
    </div>

    <!-- ===== CONFIRM MODAL ===== -->
    <div id="confirm-modal" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="confirm-title" style="margin-top: 0;">Bekr√§fta</h3>
            <p id="confirm-message" style="color: var(--text-muted);"></p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn" style="background: #64748b; width: auto;" onclick="confirmReject()">Avbryt</button>
                <button class="btn" style="background: #ef4444; width: auto;" onclick="confirmResolve()">Bekr√§fta</button>
            </div>
        </div>
    </div>

    <!-- ===== SETTINGS MODAL ===== -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <button class="modal-close" onclick="closeSettingsModal()">‚úñ</button>
            <h2 style="margin-top: 0;">‚öôÔ∏è Inst√§llningar</h2>
            <div class="form-group">
                <label for="company-name-input">F√∂retagsnamn</label>
                <input type="text" id="company-name-input" placeholder="Mitt F√∂retag AB">
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Spara inst√§llningar</button>

            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--card-border);">
            <h4 style="margin: 0 0 1rem 0;">üíæ S√§kerhetskopiering</h4>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-export" style="flex: 1;" onclick="downloadBackup()">üì• Ladda ner backup</button>
                <label class="btn btn-secondary" style="flex: 1; cursor: pointer; justify-content: center;">
                    üì§ √Öterst√§ll backup
                    <input type="file" accept=".json" style="display:none;" onchange="restoreBackup(this.files[0]); this.value='';">
                </label>
            </div>
        </div>
    </div>

    <script>
        // ================================================================
        // 1. DATABAS & GLOBAL STATE
        // ================================================================
        const DB_KEY   = 'timetrack_pro_v3';
        const LOGS_KEY = 'timetrack_logs_v3';

        const defaultEmployees = [
            { id: "1", name: "Admin",          pin: "9999", role: "admin",   wage: 0,   status: "Utloggad", activeSession: null, workedHistory: [], schedule: [],                                                    vacationDaysLeft: 25, sickDaysUsed: 0 },
            { id: "2", name: "Alex (Du)",       pin: "1234", role: "worker",  wage: 150, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [{ day: "2026-02-27", time: "08:00 - 16:00" }], vacationDaysLeft: 25, sickDaysUsed: 0 },
            { id: "3", name: "Sara Andersson",  pin: "5678", role: "worker",  wage: 160, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [],                                                    vacationDaysLeft: 25, sickDaysUsed: 0 }
        ];

        let employees         = JSON.parse(localStorage.getItem(DB_KEY))   || defaultEmployees;
        let logs              = JSON.parse(localStorage.getItem(LOGS_KEY)) || [];
        let currentUser       = null;
        let liveTimerInterval = null;
        let logDisplayCount   = 50;
        const shownReminders  = new Set();
        let inactivityTimer   = null;
        const INACTIVITY_MS   = 15 * 60 * 1000; // 15 minutes

        // Migrate existing employees ‚Äî add new fields if missing
        employees.forEach(emp => {
            if (emp.vacationDaysLeft === undefined) emp.vacationDaysLeft = 25;
            if (emp.sickDaysUsed    === undefined) emp.sickDaysUsed    = 0;
            emp.workedHistory.forEach(s => { if (s.otHours === undefined) s.otHours = 0; });
        });

        function saveData() {
            localStorage.setItem(DB_KEY,   JSON.stringify(employees));
            localStorage.setItem(LOGS_KEY, JSON.stringify(logs));
        }

        // ================================================================
        // 2. TOASTS & KLOCKA
        // ================================================================
        function showToast(msg, type = '') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function updateClock() {
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('live-clock').innerText = "Systemtid: " + new Date().toLocaleDateString('sv-SE', opts);
        }
        setInterval(updateClock, 1000); updateClock();

        // ================================================================
        // 3. AKTIVITETSLOGG (cap 100, search, visa fler)
        // ================================================================
        function addLog(action, userName = null) {
            const name = userName || (currentUser ? currentUser.name : "System");
            logs.unshift({ name, action, time: new Date().toLocaleTimeString('sv-SE') });
            if (logs.length > 100) logs.pop();
            saveData();
            if (currentUser && currentUser.role === 'admin') renderLogs();
        }

        function renderLogs() {
            const list = document.getElementById('activity-log-list');
            if (!list) return;

            const filter = (document.getElementById('log-search')?.value || '').toLowerCase();
            const filtered = filter
                ? logs.filter(l => l.name.toLowerCase().includes(filter) || l.action.toLowerCase().includes(filter))
                : logs;

            list.innerHTML = filtered.slice(0, logDisplayCount)
                .map(l => `<li><span><strong>${l.name}</strong>: ${l.action}</span><span class="log-time">${l.time}</span></li>`)
                .join('');

            const btn = document.getElementById('log-show-more');
            if (btn) btn.style.display = filtered.length > logDisplayCount ? 'block' : 'none';
        }

        function showMoreLogs() {
            logDisplayCount += 50;
            renderLogs();
        }

        // ================================================================
        // 4. TEMA & N√ÑTVERK
        // ================================================================
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('tt_theme', isDark ? 'dark' : 'light');
            if (window.myChart) { Chart.defaults.color = isDark ? '#94a3b8' : '#64748b'; window.myChart.update(); }
        }
        if (localStorage.getItem('tt_theme') === 'dark') document.body.classList.add('dark-mode');

        function updateNetworkStatus(isOnline) {
            const el = document.getElementById('network-status');
            if (isOnline) { el.className = 'network-badge online'; el.innerText = 'üü¢ Online'; }
            else          { el.className = 'network-badge offline'; el.innerText = 'üî¥ Offline'; showToast('Du √§r offline. Allt sparas lokalt.', 'warning'); }
        }
        window.addEventListener('online',  () => updateNetworkStatus(true));
        window.addEventListener('offline', () => updateNetworkStatus(false));
        if (!navigator.onLine) updateNetworkStatus(false);

        // Enter key on PIN field triggers login
        document.getElementById('login-pin').addEventListener('keydown', e => {
            if (e.key === 'Enter') doLogin();
        });

        // ================================================================
        // INAKTIVITETS-TIMEOUT (15 min)
        // ================================================================
        function resetInactivityTimer() {
            if (!currentUser) return;
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (currentUser) {
                    showToast('Automatisk utloggning efter 15 min inaktivitet.', 'warning');
                    logout();
                }
            }, INACTIVITY_MS);
        }

        ['mousemove', 'keydown', 'click', 'touchstart'].forEach(evt => {
            document.addEventListener(evt, resetInactivityTimer, { passive: true });
        });

        // ================================================================
        // 5. INLOGGNING
        // ================================================================
        function clearPinError() {
            document.getElementById('pin-error').innerText = '';
            document.getElementById('login-pin').classList.remove('shake');
        }

        function doLogin() {
            const pin = document.getElementById('login-pin').value;
            currentUser = employees.find(emp => emp.pin === pin);

            if (!currentUser) {
                const pinInput = document.getElementById('login-pin');
                pinInput.value = '';
                pinInput.classList.remove('shake');
                void pinInput.offsetWidth; // reflow to restart animation
                pinInput.classList.add('shake');
                document.getElementById('pin-error').innerText = 'Fel PIN-kod';
                showToast("Fel PIN-kod", "error");
                return;
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('logged-in-user').innerText = `üë§ ${currentUser.name}`;
            updateCompanyName();

            if (currentUser.role === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('worker-view').classList.add('hidden');
                document.getElementById('settings-btn').classList.remove('hidden');
                loadAdminData();
                showToast("Inloggad som Admin", "success");
            } else {
                document.getElementById('worker-view').classList.remove('hidden');
                document.getElementById('admin-view').classList.add('hidden');
                document.getElementById('settings-btn').classList.add('hidden');
                loadWorkerView();
                showToast("V√§lkommen!", "success");
                resetInactivityTimer();

                // Request notification permission and start reminder check
                if ('Notification' in window) Notification.requestPermission();
                checkShiftReminders();
                setInterval(checkShiftReminders, 60000);
            }
        }

        function logout() {
            clearInterval(liveTimerInterval);
            clearTimeout(inactivityTimer);
            currentUser = null;
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-pin').value = '';
            document.getElementById('pin-error').innerText = '';
            showToast("Utloggad.");
        }

        // ================================================================
        // 6. OB-BER√ÑKNING (automatisk, 5-min slices)
        // ================================================================
        function isOBTime(date) {
            const day = date.getDay(); // 0=s√∂n, 6=l√∂r
            if (day === 0 || day === 6) return true;
            const minutes = date.getHours() * 60 + date.getMinutes();
            return minutes < 7 * 60 || minutes >= 18 * 60;
        }

        function calculateOBSplit(session) {
            const endTime   = Date.now();
            const SLICE_MS  = 5 * 60 * 1000;

            // Build worked intervals by excluding breaks
            const sortedBreaks = [...session.breaks].sort((a, b) => a.start - b.start);
            const intervals = [];
            let cur = session.startTime;

            for (const brk of sortedBreaks) {
                if (brk.start > cur) intervals.push({ start: cur, end: brk.start });
                cur = brk.end || endTime;
            }
            if (cur < endTime) intervals.push({ start: cur, end: endTime });

            let regularMs = 0, obMs = 0;
            for (const iv of intervals) {
                let t = iv.start;
                while (t < iv.end) {
                    const sliceEnd = Math.min(t + SLICE_MS, iv.end);
                    const midpoint = new Date((t + sliceEnd) / 2);
                    if (isOBTime(midpoint)) obMs += sliceEnd - t;
                    else regularMs += sliceEnd - t;
                    t = sliceEnd;
                }
            }

            return { regularHours: regularMs / 3600000, obHours: obMs / 3600000 };
        }

        // ================================================================
        // 7. SKIFTP√ÖMINNELSER
        // ================================================================
        function checkShiftReminders() {
            if (!currentUser?.schedule) return;
            const now = new Date();

            currentUser.schedule.forEach(shift => {
                const startStr = shift.time.split(' - ')[0]?.trim();
                if (!startStr) return;

                const shiftStart = new Date(`${shift.day}T${startStr}:00`);
                const diffMin    = (shiftStart - now) / 60000;
                const key        = `${shift.day}_${startStr}`;

                if (diffMin > 0 && diffMin <= 30 && !shownReminders.has(key)) {
                    shownReminders.add(key);
                    if (Notification.permission === 'granted') {
                        new Notification('‚è∞ Skiftp√•minnelse', {
                            body: `Ditt skift ${shift.day} ${shift.time} b√∂rjar om ${Math.round(diffMin)} minuter!`
                        });
                    }
                    showToast(`Skiftet b√∂rjar om ${Math.round(diffMin)} min!`, 'warning');
                }
            });
        }

        // ================================================================
        // 8. TIDTAGNING & ARBETAR-VY
        // ================================================================
        function getElapsedMs(session) {
            if (!session) return 0;
            let total = Date.now() - session.startTime;
            session.breaks.forEach(b => { total -= (b.end ? b.end - b.start : Date.now() - b.start); });
            return total;
        }

        function loadWorkerView() {
            updateWorkerControls();

            let totHrs = 0, obHrs = 0, otHrs = 0;
            currentUser.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; otHrs += (s.otHours || 0); });

            const gross = (totHrs * currentUser.wage) + (obHrs * currentUser.wage * 1.5) + (otHrs * currentUser.wage * 0.5);
            document.getElementById('worker-hours').innerText         = totHrs.toFixed(2) + "h";
            document.getElementById('worker-ob-hours').innerText      = obHrs.toFixed(2)  + "h";
            document.getElementById('worker-ot-hours').innerText      = otHrs.toFixed(2)  + "h";
            document.getElementById('worker-earned').innerText        = Math.round(gross).toLocaleString('sv-SE') + " kr";
            document.getElementById('worker-vacation-days').innerText = currentUser.vacationDaysLeft ?? 25;
            document.getElementById('worker-sick-days').innerText     = currentUser.sickDaysUsed ?? 0;

            const ul = document.getElementById('schedule-list'); ul.innerHTML = '';
            currentUser.schedule.forEach((shift, i) => {
                ul.innerHTML += `<li><div><strong>${shift.day}</strong> <span style="margin-left:10px; color:var(--text-muted);">${shift.time}</span></div><button class="btn-sm btn-delete" onclick="deleteShiftWorker(${i})">‚úñ Ta bort</button></li>`;
            });
        }

        function updateWorkerControls() {
            const badge    = document.getElementById('worker-status-badge');
            badge.innerText  = currentUser.status;
            badge.className  = `badge ${currentUser.status.toLowerCase()}`;

            const btnContainer = document.getElementById('worker-action-buttons');
            const timerEl      = document.getElementById('active-session-timer');
            clearInterval(liveTimerInterval);

            if (['Utloggad', 'Sjuk', 'Semester'].includes(currentUser.status)) {
                timerEl.style.display = 'none';
                btnContainer.innerHTML = `
                    <button class="btn btn-in"    onclick="clockIn()">‚ñ∂ Klocka In (GPS)</button>
                    <button class="btn btn-sick"  onclick="setStatus('Sjuk')">ü§í Sjuk</button>
                    <button class="btn btn-leave" onclick="setStatus('Semester')">üèñÔ∏è Ledighet</button>
                `;
            } else if (currentUser.status === 'Inloggad') {
                timerEl.style.display = 'block'; startLiveTimer();
                btnContainer.innerHTML = `
                    <button class="btn btn-break" onclick="toggleBreak(true)">‚òï B√∂rja Rast</button>
                    <button class="btn btn-out"   onclick="clockOut()">‚èπ St√§mpla Ut</button>
                `;
            } else if (currentUser.status === 'Rast') {
                timerEl.style.display = 'block'; timerEl.innerText = "PAUSAD ‚òï";
                btnContainer.innerHTML = `<button class="btn btn-in" onclick="toggleBreak(false)">‚ñ∂ Avsluta Rast</button>`;
            }
        }

        function startLiveTimer() {
            liveTimerInterval = setInterval(() => {
                const ms    = getElapsedMs(currentUser.activeSession);
                const hours = Math.floor(ms / 3600000);
                const mins  = Math.floor((ms % 3600000) / 60000);
                const secs  = Math.floor((ms % 60000) / 1000);
                document.getElementById('active-session-timer').innerText =
                    `${String(hours).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            }, 1000);
        }

        function clockIn() {
            currentUser.status        = 'Inloggad';
            currentUser.activeSession = { startTime: Date.now(), breaks: [] };

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    pos => { addLog(`St√§mplade in üìç (Lat: ${pos.coords.latitude.toFixed(2)})`); saveData(); },
                    ()  => { addLog("St√§mplade in"); saveData(); },
                    { timeout: 3000 }
                );
            } else { addLog("St√§mplade in"); }

            saveData(); loadWorkerView(); showToast("Inloggad och tiden g√•r!", "success");
        }

        function toggleBreak(isStarting) {
            if (isStarting) {
                currentUser.status = 'Rast';
                currentUser.activeSession.breaks.push({ start: Date.now(), end: null });
                addLog("B√∂rjade rast ‚òï"); showToast("Rast startad. Tiden √§r pausad.", "warning");
            } else {
                currentUser.status = 'Inloggad';
                const b = currentUser.activeSession.breaks.find(b => b.end === null);
                if (b) b.end = Date.now();
                addLog("Avslutade rast ‚ñ∂"); showToast("√Öter i arbete.", "success");
            }
            saveData(); loadWorkerView();
        }

        function clockOut() {
            const split    = calculateOBSplit(currentUser.activeSession);
            const totalHrs = split.regularHours + split.obHours;

            // Overtime: hours beyond 8h in the same calendar day
            const today         = new Date().toLocaleDateString('sv-SE');
            const alreadyToday  = currentUser.workedHistory
                .filter(s => s.date === today)
                .reduce((sum, s) => sum + s.hours + s.obHours, 0);
            const otHours = Math.max(0, alreadyToday + totalHrs - 8);

            currentUser.workedHistory.push({
                date:    today,
                hours:   split.regularHours,
                obHours: split.obHours,
                otHours: otHours
            });

            currentUser.status        = 'Utloggad';
            currentUser.activeSession = null;
            addLog(`St√§mplade ut. Vanlig: ${split.regularHours.toFixed(2)}h, OB: ${split.obHours.toFixed(2)}h, OT: ${otHours.toFixed(2)}h`);
            saveData(); loadWorkerView();
            showToast(`Utst√§mplad! ${totalHrs.toFixed(2)}h totalt (OB: ${split.obHours.toFixed(2)}h, OT: ${otHours.toFixed(2)}h)`, "success");
        }

        function setStatus(status) {
            if (status === 'Semester') {
                const left = currentUser.vacationDaysLeft ?? 25;
                if (left <= 0) return showToast("Inga semesterdagar kvar!", "error");
                currentUser.vacationDaysLeft = left - 1;
            }
            if (status === 'Sjuk') {
                currentUser.sickDaysUsed = (currentUser.sickDaysUsed ?? 0) + 1;
            }
            currentUser.status = status;
            addLog(`Satte status: ${status}`);
            saveData(); loadWorkerView(); showToast(`Status satt till ${status}`);
        }

        // Worker schema
        function addShift() {
            const d = document.getElementById('new-shift-day').value;
            const s = document.getElementById('new-shift-start').value;
            const e = document.getElementById('new-shift-end').value;
            if (!d || !s || !e) return showToast("Fyll i datum och tider.", "warning");
            if (s >= e)         return showToast("Sluttiden m√•ste vara efter start.", "error");
            currentUser.schedule.push({ day: d, time: `${s} - ${e}` });
            document.getElementById('new-shift-day').value = '';
            document.getElementById('new-shift-start').value = '';
            document.getElementById('new-shift-end').value = '';
            saveData(); loadWorkerView(); showToast("Pass tillagt!", "success");
        }

        function deleteShiftWorker(i) {
            currentUser.schedule.splice(i, 1);
            saveData(); loadWorkerView(); showToast("Pass borttaget", "warning");
        }

        // ================================================================
        // 9. PROGRESSIV SKATTEBER√ÑKNING
        // ================================================================
        function getTaxBreakdown(grossMonthly) {
            const kommunal    = grossMonthly * 0.3149;
            const statligBase = Math.max(0, grossMonthly - 46000);
            const statlig     = statligBase * 0.20;
            return { kommunal, statlig, total: kommunal + statlig };
        }

        function openPayslipModal() {
            let totHrs = 0, obHrs = 0, otHrs = 0;
            currentUser.workedHistory.forEach(s => { totHrs += s.hours; obHrs += s.obHours; otHrs += (s.otHours || 0); });

            const regPay = totHrs * currentUser.wage;
            const obPay  = obHrs  * (currentUser.wage * 1.5);
            const otPay  = otHrs  * (currentUser.wage * 0.5); // 50% bonus on top of base
            const gross  = regPay + obPay + otPay;
            const tax    = getTaxBreakdown(gross);
            const net    = gross - tax.total;

            document.getElementById('payslip-company').innerText    = localStorage.getItem('tt_company') || '';
            document.getElementById('payslip-name').innerText       = currentUser.name;
            document.getElementById('payslip-date').innerText       = new Date().toLocaleDateString('sv-SE', { year: 'numeric', month: 'long' });
            document.getElementById('payslip-reg-hours').innerText  = totHrs.toFixed(2);
            document.getElementById('payslip-reg-wage').innerText   = currentUser.wage;
            document.getElementById('payslip-reg-total').innerText  = Math.round(regPay).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-ob-hours').innerText   = obHrs.toFixed(2);
            document.getElementById('payslip-ob-wage').innerText    = currentUser.wage * 1.5;
            document.getElementById('payslip-ob-total').innerText   = Math.round(obPay).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-ot-hours').innerText   = otHrs.toFixed(2);
            document.getElementById('payslip-ot-wage').innerText    = (currentUser.wage * 0.5).toFixed(0);
            document.getElementById('payslip-ot-total').innerText   = Math.round(otPay).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-grand-total').innerText = Math.round(gross).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-kommunal').innerText   = "-" + Math.round(tax.kommunal).toLocaleString('sv-SE') + " kr";
            document.getElementById('payslip-statlig').innerText    = "-" + Math.round(tax.statlig).toLocaleString('sv-SE')  + " kr";
            document.getElementById('payslip-net-total').innerText  = Math.round(net).toLocaleString('sv-SE') + " kr";

            document.getElementById('payslip-modal').classList.add('active');
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'] });
        }

        function closePayslipModal() { document.getElementById('payslip-modal').classList.remove('active'); }

        // ================================================================
        // 10. ADMIN-VY & L√ñNEPERIODER
        // ================================================================
        function getFilteredHistory(emp) {
            const filter = document.getElementById('period-filter')?.value || 'all';
            if (filter === 'all') return emp.workedHistory;

            const now = new Date();
            return emp.workedHistory.filter(s => {
                // Stored as sv-SE locale string ‚Äî typically YYYY-MM-DD
                const d = new Date(s.date);
                if (isNaN(d)) return true; // keep if unparseable
                if (filter === 'week') {
                    const weekStart = new Date(now);
                    const dow = now.getDay() || 7; // Monday=1
                    weekStart.setDate(now.getDate() - dow + 1);
                    weekStart.setHours(0, 0, 0, 0);
                    return d >= weekStart;
                }
                if (filter === 'month') {
                    return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
                }
                return true;
            });
        }

        function loadAdminData() {
            const tbody = document.getElementById('payroll-body'); tbody.innerHTML = '';
            const chartLabels = [], chartRegularPay = [], chartOBPay = [];

            renderLogs();

            employees.filter(e => e.role !== 'admin').forEach(emp => {
                const hist = getFilteredHistory(emp);
                let totHrs = 0, obHrs = 0, otHrs = 0;
                hist.forEach(s => { totHrs += s.hours; obHrs += s.obHours; otHrs += (s.otHours || 0); });

                const regPay = totHrs * emp.wage;
                const obPay  = obHrs  * (emp.wage * 1.5);
                const otPay  = otHrs  * (emp.wage * 0.5);
                const gross  = regPay + obPay + otPay;

                chartLabels.push(emp.name.split(' ')[0]);
                chartRegularPay.push(regPay);
                chartOBPay.push(obPay);

                tbody.innerHTML += `<tr class="employee-row">
                    <td class="emp-name"><strong class="clickable-name" onclick="openEditModal('${emp.id}')">${emp.name}</strong><br><small style="color:var(--text-muted)">${emp.wage} kr/h</small></td>
                    <td><span class="badge ${emp.status.toLowerCase()}">${emp.status}</span></td>
                    <td>${totHrs.toFixed(2)}h</td>
                    <td style="color: #8b5cf6; font-weight:bold;">${obHrs.toFixed(2)}h</td>
                    <td><strong>${Math.round(gross).toLocaleString('sv-SE')} kr</strong></td>
                    <td>
                        <button class="btn-sm btn-edit"   onclick="openEditModal('${emp.id}')">Redigera</button>
                        <button class="btn-sm btn-delete" onclick="deleteEmployee('${emp.id}')">‚úñ</button>
                    </td>
                </tr>`;
            });

            updateChart(chartLabels, chartRegularPay, chartOBPay);
        }

        function filterTable() {
            const filter = document.getElementById('search-employee').value.toLowerCase();
            [...document.getElementsByClassName('employee-row')].forEach(row => {
                const name = row.querySelector('.emp-name');
                row.style.display = (name?.textContent || '').toLowerCase().includes(filter) ? '' : 'none';
            });
        }

        function addEmployee() {
            const name = document.getElementById('new-name').value;
            const pin  = document.getElementById('new-pin').value;
            const wage = parseInt(document.getElementById('new-wage').value);

            if (!name || !pin || isNaN(wage)) return showToast("Fyll i namn, PIN och l√∂n.", "warning");
            if (employees.find(e => e.pin === pin)) return showToast("PIN-koden anv√§nds redan!", "error");

            employees.push({ id: Date.now().toString(), name, pin, role: "worker", wage, status: "Utloggad", activeSession: null, workedHistory: [], schedule: [], vacationDaysLeft: 25, sickDaysUsed: 0 });
            document.getElementById('new-name').value = '';
            document.getElementById('new-pin').value  = '';
            document.getElementById('new-wage').value = '';
            saveData(); loadAdminData(); showToast("Anst√§lld tillagd!", "success");
        }

        async function deleteEmployee(id) {
            try {
                await confirmAction("√Ñr du s√§ker p√• att du vill radera denna anst√§lld och dess historik?", "Radera anst√§lld");
                employees = employees.filter(e => e.id !== id);
                saveData(); loadAdminData(); showToast("Anst√§lld raderad");
            } catch (_) {}
        }

        // ================================================================
        // 11. BEKR√ÑFTELSEDIALOG
        // ================================================================
        let _confirmResolve = null;
        let _confirmReject  = null;

        function confirmAction(message, title = 'Bekr√§fta') {
            document.getElementById('confirm-title').innerText   = title;
            document.getElementById('confirm-message').innerText = message;
            document.getElementById('confirm-modal').classList.add('active');
            return new Promise((resolve, reject) => {
                _confirmResolve = resolve;
                _confirmReject  = reject;
            });
        }

        function confirmResolve() {
            document.getElementById('confirm-modal').classList.remove('active');
            if (_confirmResolve) { _confirmResolve(); _confirmResolve = _confirmReject = null; }
        }

        function confirmReject() {
            document.getElementById('confirm-modal').classList.remove('active');
            if (_confirmReject) { _confirmReject(new Error('cancelled')); _confirmResolve = _confirmReject = null; }
        }

        // ================================================================
        // 12. ADMIN EDIT MODAL & RENSA HISTORIK
        // ================================================================
        function openEditModal(id) {
            const emp = employees.find(e => e.id === id);
            document.getElementById('edit-emp-id').value           = id;
            document.getElementById('edit-modal-title').innerText  = "Profil: " + emp.name;
            document.getElementById('edit-name').value             = emp.name;
            document.getElementById('edit-pin').value              = emp.pin;
            document.getElementById('edit-wage').value             = emp.wage;
            document.getElementById('edit-vacation-days').value    = emp.vacationDaysLeft ?? 25;
            renderModalSchedule(id);
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }

        function saveEmployeeEdit() {
            const id         = document.getElementById('edit-emp-id').value;
            const emp        = employees.find(e => e.id === id);
            const newName    = document.getElementById('edit-name').value;
            const newPin     = document.getElementById('edit-pin').value;
            const newWage    = parseInt(document.getElementById('edit-wage').value);
            const newVacation = parseInt(document.getElementById('edit-vacation-days').value);

            if (!newName || !newPin || isNaN(newWage)) return showToast("Fyll i alla f√§lt.", "warning");
            if (employees.find(e => e.pin === newPin && e.id !== id)) return showToast("PIN-koden anv√§nds redan!", "error");

            emp.name  = newName;
            emp.pin   = newPin;
            emp.wage  = newWage;
            if (!isNaN(newVacation)) emp.vacationDaysLeft = newVacation;

            saveData(); loadAdminData(); showToast("Uppgifter sparade!", "success"); closeEditModal();
        }

        async function clearEmployeeHistory() {
            const id  = document.getElementById('edit-emp-id').value;
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            try {
                await confirmAction(`Rensa all historik f√∂r ${emp.name}? Sjukdagar nollst√§lls men semesterdagar p√•verkas inte.`, "Rensa historik");
                emp.workedHistory = [];
                emp.sickDaysUsed  = 0;
                addLog(`Historik rensad f√∂r ${emp.name}`);
                saveData(); loadAdminData();
                showToast("Historik rensad!", "success");
            } catch (_) {}
        }

        // Schema vs faktisk tid
        function renderModalSchedule(id) {
            const emp  = employees.find(e => e.id === id);
            const list = document.getElementById('modal-schedule-list');
            list.innerHTML = '';

            if (!emp.schedule.length) {
                list.innerHTML = '<li><em style="color:var(--text-muted)">Inget schema inlagt.</em></li>';
                return;
            }

            emp.schedule.forEach((shift, index) => {
                let workedInfo = '';
                const parts = shift.time.split(' - ');
                if (parts.length === 2) {
                    const [sh, sm] = parts[0].trim().split(':').map(Number);
                    const [eh, em] = parts[1].trim().split(':').map(Number);
                    const scheduled = ((eh * 60 + em) - (sh * 60 + sm)) / 60;

                    const sessions = emp.workedHistory.filter(s => s.date === shift.day);
                    if (sessions.length) {
                        const worked = sessions.reduce((sum, s) => sum + s.hours + s.obHours, 0);
                        const diff   = worked - scheduled;
                        const color  = diff >= 0 ? '#10b981' : '#ef4444';
                        const sign   = diff >= 0 ? '+' : '';
                        workedInfo = `<span style="color:${color}; font-size:0.8rem; margin-left:0.5rem;">| Jobbade: ${worked.toFixed(1)}h (${sign}${diff.toFixed(1)}h)</span>`;
                    }
                }

                list.innerHTML += `<li>
                    <div>
                        <strong>${shift.day}</strong>
                        <span style="margin-left:10px; color:var(--text-muted);">${shift.time}</span>
                        ${workedInfo}
                    </div>
                    <button class="btn-sm btn-delete" onclick="deleteShiftFromModal('${id}', ${index})">‚úñ</button>
                </li>`;
            });
        }

        function deleteShiftFromModal(id, index) {
            employees.find(e => e.id === id).schedule.splice(index, 1);
            saveData(); renderModalSchedule(id);
        }

        function addShiftFromModal() {
            const id = document.getElementById('edit-emp-id').value;
            const d  = document.getElementById('modal-shift-day').value;
            const s  = document.getElementById('modal-shift-start').value;
            const e  = document.getElementById('modal-shift-end').value;
            if (!d || !s || !e) return showToast("Fyll i datum och tider.", "warning");
            if (s >= e)         return showToast("Sluttiden m√•ste vara efter start.", "error");
            employees.find(emp => emp.id === id).schedule.push({ day: d, time: `${s} - ${e}` });
            document.getElementById('modal-shift-day').value   = '';
            document.getElementById('modal-shift-start').value = '';
            document.getElementById('modal-shift-end').value   = '';
            saveData(); renderModalSchedule(id); showToast("Pass tillagt!", "success");
        }

        // ================================================================
        // 13. INST√ÑLLNINGAR & F√ñRETAGSNAMN
        // ================================================================
        function updateCompanyName() {
            const name = localStorage.getItem('tt_company') || 'TimeTrack';
            document.getElementById('nav-company-name').innerText = `‚è±Ô∏è ${name}`;
        }

        function openSettingsModal() {
            document.getElementById('company-name-input').value = localStorage.getItem('tt_company') || '';
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() { document.getElementById('settings-modal').classList.remove('active'); }

        function saveSettings() {
            const name = document.getElementById('company-name-input').value.trim();
            if (name) localStorage.setItem('tt_company', name);
            else      localStorage.removeItem('tt_company');
            updateCompanyName();
            closeSettingsModal();
            showToast("Inst√§llningar sparade!", "success");
        }

        // Init company name on page load
        updateCompanyName();

        // ================================================================
        // 14. EXPORT CSV & CHART
        // ================================================================
        function exportCSV() {
            let csv = "data:text/csv;charset=utf-8,Namn;Status;Vanlig Tid(h);OB-Tid(h);Timlon;Bruttolon(kr)\n";
            employees.filter(e => e.role !== 'admin').forEach(emp => {
                let t = 0, o = 0;
                emp.workedHistory.forEach(s => { t += s.hours; o += s.obHours; });
                csv += `${emp.name};${emp.status};${t.toFixed(2)};${o.toFixed(2)};${emp.wage};${Math.round((t * emp.wage) + (o * emp.wage * 1.5))}\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", "Lonelista_Pro.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showToast("CSV nedladdad!", "success");
        }

        // ================================================================
        // 15. BACKUP & √ÖTERST√ÑLLNING
        // ================================================================
        function downloadBackup() {
            const data = {
                version:    1,
                exportedAt: new Date().toISOString(),
                employees,
                logs
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href     = url;
            a.download = `timetrack_backup_${new Date().toLocaleDateString('sv-SE')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup nedladdad!', 'success');
        }

        async function restoreBackup(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data.employees)) return showToast('Ogiltig backupfil.', 'error');
                    const date = data.exportedAt
                        ? new Date(data.exportedAt).toLocaleDateString('sv-SE')
                        : 'ok√§nt datum';
                    try {
                        await confirmAction(
                            `√Öterst√§lla backup fr√•n ${date}? All nuvarande data ers√§tts.`,
                            '√Öterst√§ll backup'
                        );
                        employees = data.employees;
                        logs      = data.logs || [];
                        // Ensure new fields exist on restored data
                        employees.forEach(emp => {
                            if (emp.vacationDaysLeft === undefined) emp.vacationDaysLeft = 25;
                            if (emp.sickDaysUsed    === undefined) emp.sickDaysUsed    = 0;
                        });
                        saveData();
                        showToast('Backup √•terst√§lld! Laddar om...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } catch (_) {}
                } catch (_) {
                    showToast('Kunde inte l√§sa backupfilen.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function updateChart(labels, regularData, obData) {
            const ctx  = document.getElementById('salaryChart').getContext('2d');
            const dark = document.body.classList.contains('dark-mode');
            Chart.defaults.color       = dark ? '#94a3b8' : '#64748b';
            Chart.defaults.font.family = 'Inter';
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Vanlig L√∂n (kr)', data: regularData, backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'OB-till√§gg (kr)',  data: obData,      backgroundColor: '#8b5cf6', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, border: { display: false } }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
    </script>
</body>
</html>
